import streamlit as st
import FinanceDataReader as fdr
import pandas as pd
import datetime
import concurrent.futures
import plotly.graph_objects as go

# -----------------------------------------------------------
# [1] 기본 설정
# -----------------------------------------------------------
st.set_page_config(layout="wide", page_title="Easy Swing Trader v8.0 (Top 200)")

# -----------------------------------------------------------
# [2] 데이터 수집 엔진 (TOP 200 하드코딩)
# -----------------------------------------------------------
@st.cache_data
def get_stock_list():
    # Streamlit Cloud 차단 방지를 위한 우량주 200개 리스트 (KOSPI+KOSDAQ)
    data = [
        # --- 반도체 & IT & 하드웨어 ---
        {'Code': '005930', 'Name': '삼성전자'}, {'Code': '000660', 'Name': 'SK하이닉스'},
        {'Code': '042700', 'Name': '한미반도체'}, {'Code': '000100', 'Name': '유한양행'},
        {'Code': '018260', 'Name': '삼성에스디에스'}, {'Code': '011070', 'Name': 'LG이노텍'},
        {'Code': '009150', 'Name': '삼성전기'}, {'Code': '403870', 'Name': 'HPSP'},
        {'Code': '005935', 'Name': '삼성전자우'}, {'Code': '003380', 'Name': '하림지주'},
        {'Code': '052690', 'Name': '한전기술'}, {'Code': '022100', 'Name': '포스코DX'},
        {'Code': '036570', 'Name': '엔씨소프트'}, {'Code': '251270', 'Name': '넷마블'},
        {'Code': '068240', 'Name': '다원시스'}, {'Code': '322000', 'Name': 'HD현대에너지솔루션'},
        {'Code': '008770', 'Name': '호텔신라'}, {'Code': '030000', 'Name': '제일기획'},
        
        # --- 플랫폼 & 게임 & 엔터 ---
        {'Code': '035420', 'Name': 'NAVER'}, {'Code': '035720', 'Name': '카카오'},
        {'Code': '293490', 'Name': '카카오게임즈'}, {'Code': '263750', 'Name': '펄어비스'},
        {'Code': '035900', 'Name': 'JYP Ent.'}, {'Code': '041510', 'Name': '에스엠'},
        {'Code': '122870', 'Name': '와이지엔터테인먼트'}, {'Code': '352820', 'Name': '하이브'},
        {'Code': '090350', 'Name': '노랑풍선'}, {'Code': '079160', 'Name': 'CJ CGV'},
        {'Code': '053800', 'Name': '안랩'}, {'Code': '033640', 'Name': '네패스'},

        # --- 자동차 & 운송 & 조선 ---
        {'Code': '005380', 'Name': '현대차'}, {'Code': '000270', 'Name': '기아'},
        {'Code': '012330', 'Name': '현대모비스'}, {'Code': '086280', 'Name': '현대글로비스'},
        {'Code': '003490', 'Name': '대한항공'}, {'Code': '011200', 'Name': 'HMM'},
        {'Code': '000120', 'Name': 'CJ대한통운'}, {'Code': '042660', 'Name': '한화오션'},
        {'Code': '009540', 'Name': 'HD한국조선해양'}, {'Code': '010140', 'Name': '삼성중공업'},
        {'Code': '010620', 'Name': '현대미포조선'}, {'Code': '028670', 'Name': '팬오션'},
        {'Code': '003620', 'Name': '쌍용C&E'}, {'Code': '000720', 'Name': '현대건설'},

        # --- 2차전지 & 화학 & 에너지 ---
        {'Code': '373220', 'Name': 'LG에너지솔루션'}, {'Code': '006400', 'Name': '삼성SDI'},
        {'Code': '051910', 'Name': 'LG화학'}, {'Code': '005490', 'Name': 'POSCO홀딩스'},
        {'Code': '247540', 'Name': '에코프로비엠'}, {'Code': '086520', 'Name': '에코프로'},
        {'Code': '003670', 'Name': '포스코퓨처엠'}, {'Code': '066970', 'Name': '엘앤에프'},
        {'Code': '096770', 'Name': 'SK이노베이션'}, {'Code': '051900', 'Name': 'LG생활건강'},
        {'Code': '090430', 'Name': '아모레퍼시픽'}, {'Code': '010950', 'Name': 'S-Oil'},
        {'Code': '078930', 'Name': 'GS'}, {'Code': '271560', 'Name': '오리온'},
        {'Code': '097950', 'Name': 'CJ제일제당'}, {'Code': '011170', 'Name': '롯데케미칼'},
        {'Code': '011780', 'Name': '금호석유'}, {'Code': '004020', 'Name': '현대제철'},
        {'Code': '010130', 'Name': '고려아연'}, {'Code': '009830', 'Name': '한화솔루션'},
        {'Code': '112610', 'Name': '씨에스윈드'}, {'Code': '034020', 'Name': '두산에너빌리티'},
        {'Code': '015760', 'Name': '한국전력'}, {'Code': '036460', 'Name': '한국가스공사'},
        
        # --- 바이오 & 헬스케어 ---
        {'Code': '207940', 'Name': '삼성바이오로직스'}, {'Code': '068270', 'Name': '셀트리온'},
        {'Code': '028300', 'Name': 'HLB'}, {'Code': '196170', 'Name': '알테오젠'},
        {'Code': '128940', 'Name': '한미약품'}, {'Code': '328130', 'Name': '루닛'},
        {'Code': '237690', 'Name': '에스티팜'}, {'Code': '214150', 'Name': '클래시스'},
        {'Code': '145020', 'Name': '휴젤'}, {'Code': '069620', 'Name': '대웅제약'},
        {'Code': '000100', 'Name': '유한양행'}, {'Code': '019170', 'Name': '신풍제약'},
        {'Code': '091990', 'Name': '셀트리온제약'}, {'Code': '214320', 'Name': '이노션'},
        {'Code': '235980', 'Name': '메드팩토'}, {'Code': '006280', 'Name': '녹십자'},
        {'Code': '185750', 'Name': '종근당'}, {'Code': '009290', 'Name': '광동제약'},

        # --- 금융 & 지주 & 방산 & 로봇 ---
        {'Code': '105560', 'Name': 'KB금융'}, {'Code': '055550', 'Name': '신한지주'},
        {'Code': '086790', 'Name': '하나금융지주'}, {'Code': '316140', 'Name': '우리금융지주'},
        {'Code': '003550', 'Name': 'LG'}, {'Code': '000810', 'Name': '삼성화재'},
        {'Code': '032830', 'Name': '삼성생명'}, {'Code': '024110', 'Name': '기업은행'},
        {'Code': '029780', 'Name': '삼성카드'}, {'Code': '071050', 'Name': '한국금융지주'},
        {'Code': '277810', 'Name': '레인보우로보틱스'}, {'Code': '462510', 'Name': '두산로보틱스'},
        {'Code': '047050', 'Name': '포스코인터내셔널'}, {'Code': '012450', 'Name': '한화에어로스페이스'},
        {'Code': '064350', 'Name': '현대로템'}, {'Code': '079550', 'Name': 'LIG넥스원'},
        {'Code': '005950', 'Name': '이수화학'}, {'Code': '001450', 'Name': '현대해상'},
        {'Code': '028260', 'Name': '삼성물산'}, {'Code': '030200', 'Name': 'KT'},
        {'Code': '017670', 'Name': 'SK텔레콤'}, {'Code': '032640', 'Name': 'LG유플러스'},
        {'Code': '026960', 'Name': '동서'}, {'Code': '008930', 'Name': '한미사이언스'},
        {'Code': '016360', 'Name': '종합화학'}, {'Code': '001440', 'Name': '대한전선'},
        {'Code': '010120', 'Name': 'LS산전'}, {'Code': '006800', 'Name': '미래에셋증권'},
        {'Code': '005830', 'Name': 'DB손해보험'}, {'Code': '000080', 'Name': '하이트진로'},
        {'Code': '004990', 'Name': '롯데지주'}, {'Code': '007070', 'Name': 'GS리테일'},
        {'Code': '010060', 'Name': 'OCI'}, {'Code': '002380', 'Name': 'KCC'},
        {'Code': '039490', 'Name': '키움증권'}, {'Code': '036830', 'Name': '솔브레인'},
        {'Code': '240810', 'Name': '원익IPS'}, {'Code': '003000', 'Name': '부광약품'},
        {'Code': '088800', 'Name': '에이스테크'}, {'Code': '034220', 'Name': 'LG디스플레이'},
        {'Code': '056190', 'Name': '아미코젠'}, {'Code': '064260', 'Name': '다날'},
        {'Code': '010100', 'Name': '한국무브넥스'}, {'Code': '004370', 'Name': '농심'},
        {'Code': '280360', 'Name': '롯데웰푸드'}, {'Code': '005610', 'Name': 'SPC삼립'},
        {'Code': '003230', 'Name': '삼양식품'}, {'Code': '007310', 'Name': '오뚜기'},
        {'Code': '000990', 'Name': 'DB하이텍'}, {'Code': '020150', 'Name': '일진머티리얼즈'},
        {'Code': '036810', 'Name': '에프에스티'}, {'Code': '137400', 'Name': '피앤이솔루션'},
        {'Code': '095610', 'Name': '테스'}, {'Code': '046890', 'Name': '서울반도체'},
        {'Code': '131970', 'Name': '테크윙'}, {'Code': '074600', 'Name': '원익QnC'},
        {'Code': '051600', 'Name': '한전KPS'}, {'Code': '052690', 'Name': '한전기술'},
        {'Code': '213420', 'Name': '덕산네오룩스'}, {'Code': '089600', 'Name': '나스미디어'},
        {'Code': '039030', 'Name': '이오테크닉스'}, {'Code': '032500', 'Name': '케이엠더블유'},
        {'Code': '022100', 'Name': '포스코DX'}, {'Code': '060720', 'Name': 'KH바텍'},
        {'Code': '051915', 'Name': 'LG화학우'}, {'Code': '009155', 'Name': '삼성전기우'},
        {'Code': '066570', 'Name': 'LG전자'}, {'Code': '011210', 'Name': '현대위아'},
        {'Code': '009420', 'Name': '한올바이오파마'}, {'Code': '111770', 'Name': '영원무역'},
        {'Code': '002790', 'Name': '아모레G'}, {'Code': '034730', 'Name': 'SK'},
        {'Code': '030200', 'Name': 'KT'}, {'Code': '012630', 'Name': 'HDC'},
        {'Code': '000210', 'Name': 'DL'}, {'Code': '001040', 'Name': 'CJ'},
        {'Code': '021240', 'Name': '코웨이'}, {'Code': '032620', 'Name': '유비쿼스'},
        {'Code': '036930', 'Name': '주성엔지니어링'}, {'Code': '061970', 'Name': '소룩스'},
        {'Code': '067630', 'Name': '에이치엘비생명과학'}, {'Code': '175330', 'Name': 'JB금융지주'},
        {'Code': '000070', 'Name': '삼양홀딩스'}, {'Code': '014830', 'Name': '유니드'},
        {'Code': '001740', 'Name': 'SK네트웍스'}, {'Code': '011170', 'Name': '롯데케미칼'},
        {'Code': '011790', 'Name': 'SKC'}, {'Code': '020000', 'Name': '한섬'},
        {'Code': '030190', 'Name': '나이스정보통신'}, {'Code': '036580', 'Name': '팜스코'},
        {'Code': '093050', 'Name': 'LF'}, {'Code': '003240', 'Name': '태광산업'},
        {'Code': '004800', 'Name': '효성'}, {'Code': '009970', 'Name': '영원무역홀딩스'},
        {'Code': '
